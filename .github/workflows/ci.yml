name: Frontend CI

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  build-test-deploy:
    runs-on: self-hosted

    steps:
      # Step 1: Checkout code
      - name: Checkout repository
        uses: actions/checkout@v4

      # Step 2: Build Docker image
      - name: Build Docker image
        run: docker build -t angular-test-app .

      # Step 3: Run Angular tests in headless mode
      - name: Run Angular tests
        run: |
          docker run --rm -v "${{ github.workspace }}:/app" -w /app node:20-alpine sh -c "npm ci && ng test --watch=false --browsers=ChromeHeadless || echo 'No tests found'"

      # Step 4: Run app in detached mode
      - name: Start Angular app
        run: docker run -d -p 4200:80 --name angular-test angular-test-app

      # Step 5: Simple deployment test
      - name: Deployment test
        shell: bash
        run: |
          sleep 10 # give container some time to start
          if curl -f http://localhost:4200; then
            echo "Deployment test passed!"
          else
            echo "Deployment test failed"
            exit 1
          fi

      # Step 6: Stop the container after test
      - name: Stop Angular container
        run: docker stop angular-test
